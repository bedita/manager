(window.webpackJsonp=window.webpackJsonp||[]).push([["relations-add"],{27:function(t,e,i){"use strict";i.d(e,"b",function(){return a}),i.d(e,"a",function(){return s}),i.d(e,"c",function(){return r});const a={count:0,page:1,page_size:20,page_count:1},s={q:"",filter:{type:[]}},r={data:()=>({requestsQueue:[],requestController:new AbortController,objects:[],endpoint:null,pagination:a,query:{},formatObjetsFilter:["params","priority","position","url"]}),methods:{getPaginatedObjects(t=!0,e={}){let i=window.location.href;if(this.endpoint){e&&(this.query=e);let a=`${i}/${this.endpoint}`;const s={credentials:"same-origin",headers:{accept:"application/json"}};a=this.getUrlWithPaginationAndQuery(a),this.requestsQueue.length>0&&(this.requestController.abort(),this.requestController=new AbortController),s.signal=this.requestController.signal;let r=fetch(a,s).then(t=>t.json()).then(e=>{this.requestsQueue.pop();let i=(Array.isArray(e.data)?e.data:[e.data])||[];return e.data||(i=[]),this.requestsQueue.length<1&&(t&&(this.objects=i),this.pagination=e.meta&&e.meta.pagination||this.pagination,i)}).catch(t=>{if(this.requestsQueue.pop(),20===t.code)throw t;console.error(t)});return this.requestsQueue.push(r),r}return Promise.reject()},formatObjects(t){if(void 0===t)return[];const e=[];return t.forEach(t=>{let i={};i.id=t.id,i.type=t.type;const a=t.meta.relation;if(a){let t={};this.formatObjetsFilter.forEach(e=>{a[e]&&(t[e]=a[e])}),Object.keys(t).length&&(i.meta={relation:t})}e.push(i)}),e},setPagination(t){let e="",i="?";return Object.keys(this.pagination).forEach((t,i)=>{e+=`${i?"&":""}${t}=${this.pagination[t]}`}),-1===t.indexOf(i)||(i="&"),`${t}${i}${e}`},getUrlWithPaginationAndQuery(t){let e="",i="?";return Object.keys(this.pagination).forEach((t,i)=>{e+=`${i?"&":""}${t}=${this.pagination[t]}`}),e.length>1&&(e+="&"),Object.keys(this.query).forEach((t,i)=>{const a=this.query[t];let s=`${t}=${a}`;if("filter"===t){let t="";Object.keys(a).forEach(e=>{""!==a[e]&&(t+=`filter[${e}]=${a[e]}`)}),s=t}e+=`${i?"&":""}${s}`}),-1===t.indexOf(i)||(i="&"),`${t}${i}${e}`},findObjectById(t){let e=this.objects.filter(e=>e.id===t);return e.length&&e[0]},async loadMore(t=a.page_size){if(this.pagination.page_items<this.pagination.count){let e=await this.nextPage(!1);this.pagination.page_items=this.pagination.page_items+t<=this.pagination.count?this.pagination.page_items+t:this.pagination.count;const i=this.objects.length;this.objects.splice(i,0,...e)}},toPage(t,e={}){return this.pagination.page=t||1,this.getPaginatedObjects(!0,e)},firstPage(t=!0){return 1!==this.pagination.page?(this.pagination.page=1,this.getPaginatedObjects(t)):Promise.resolve([])},lastPage(t=!0){return this.pagination.page!==this.pagination.page_count?(this.pagination.page=this.pagination.page_count,this.getPaginatedObjects(t)):Promise.resolve([])},nextPage(t=!0){return this.pagination.page<this.pagination.page_count?(this.pagination.page=this.pagination.page+1,this.getPaginatedObjects(t)):Promise.resolve([])},prevPage(){return this.pagination.page>1?(this.pagination.page=this.pagination.page-1,this.getPaginatedObjects()):Promise.resolve()},setPageSize(t){this.pagination.page_size=t,this.pagination.page=1}}}},28:function(t,e,i){"use strict";const a={data:()=>({_mutationObserver:null,attrs:[]}),mounted(){this.setMutationObserver(this.attrs)},destroyed(){this._mutationObserver.disconnect()},methods:{setMutationObserver(t){this._mutationObserver=new MutationObserver(this.onAttributeChanges),this._mutationObserver.observe(this.$el,{attributes:!0,attributeFilter:t,subtree:!0,attributeOldValue:!0})},setObservableAttrs(t){this.attrs=t,this._mutationObserver.disconnect(),this.setMutationObserver(this.attrs)},onAttributeChanges(t,e){}}};i.d(e,"a",function(){return o});let s={},r={},n=null;const o={mixins:[a],props:{acceptedDrop:{type:Array,default:()=>[]}},data:()=>({attrs:["droppable","accepted-drop"],from:{},overElement:null,dropElement:null,acceptedDropArray:[],draggableElements:[],dragOverFirst:!0,antiGlitchTimer:null,_dropEnabled:!1,_sortEnabled:!1,sortableContainer:null,sortableElements:[]}),mounted(){this.initDroppableElements(),this.initDraggableElements(),this.initSortableContainer()},updated(){this.initDroppableElements(),this.initDraggableElements(),this.initSortableContainer()},destroyed(){this.dropElement.removeEventListener("dragover",this.onDragover,!1),this.dropElement.removeEventListener("dragleave",this.onDragleave,!1),this.dropElement.removeEventListener("drop",this.onDrop,!1),this.draggableElements.length&&this.$el.removeEventListener("dragstart",this.onDragstart,!1)},methods:{onAttributeChanges(t,e){for(var i of t)if("attributes"==i.type)if("droppable"===i.attributeName)this.enableDrop(),this.dropElement=i.target;else if("accepted-drop"===i.attributeName){let t=i.target.getAttribute("accepted-drop");t&&(this.acceptedDropArray=t.split(","))}else"sortable"===i.attributeName&&this.enableSort()},initDroppableElements(){if(this.dropElement=this.$el,this.dropElement){let t=this.$el.querySelector("[droppable]");if(t){this.enableDrop(),this.dropElement=t;let e=t.getAttribute("accepted-drop");e&&(this.acceptedDropArray=e.split(","))}this.dropElement.addEventListener("drop",this.onDrop,!0),this.dropElement.addEventListener("dragover",this.onDragover,!0),this.dropElement.addEventListener("dragleave",this.onDragleave,!0)}},initDraggableElements(){let t=this.$el.querySelectorAll("[draggable]");t.length&&(this.draggableElements=t,this.$el.addEventListener("dragstart",this.onDragstart,!0),this.$el.addEventListener("dragend",this.onDragend,!0))},initSortableContainer(){let t=this.$el.querySelector("[sortable]");t&&(this.enableSort(),this.sortableContainer=t,this.sortableElements=Array.from(t.querySelectorAll("[draggable]")))},setDragdropData(){s={dragged:n,over:this.overElement,drop:this.dropElement,data:r}},onDragstart(t){let e=(n=t.target).getAttribute("drag-data");try{r=JSON.parse(e)}catch(t){console.error("failed parsing drag data")}this.setDragdropData(),this.$emit("dragstart",t,r)},onDragover(t){if(t.preventDefault(),t.stopPropagation(),!this._dropEnabled)return;let e=s.dragged;this._sortEnabled&&(e.classList.add("sorting"),this.sortElement(e,t)),this.isAcceptedDrag()&&(window.clearTimeout(this.antiGlitchTimer),this.overElement=t.target,this.setDragdropData(t),this.dropElement.classList.add("dragover"),this.dragOverFirst&&(this.dragOverFirst=!1,this.$emit("dragover-once",t)),this.$emit("dragover",t))},onDragleave(t){t.preventDefault(),t.stopPropagation(),this.overElement=null,this.setDragdropData(t),this.dragOverFirst=!0,this.antiGlitchTimer=window.setTimeout(()=>{this.dropElement.classList.remove("dragover"),this.isOverChild(this.dropElement,t)||this.$emit("dragleave")},25)},onDragend(t){s={},r={},n=null},onDrop(t){if(t.preventDefault(),t.stopPropagation(),this._sortEnabled&&(n.classList.remove("sorting"),this.$emit("sort-end",s)),!this._dropEnabled||!this.isAcceptedDrag())return;this.setDragdropData(t),this.dropElement.classList.remove("dragover"),this.$emit("dragleave");let e=t.target.files||t.dataTransfer.files;e.length?(s.files=e,this.$emit("drop-files",t,s)):this.$emit("drop",t,s),n=null},isOverChild(t,e){if(!t)return!1;let i=t.getBoundingClientRect();const a=document.body.clientWidth,s=document.body.clientHeight;return!(e.clientX<=0||e.clientY<=0||e.clientX>a||e.clientY>s)&&(e.clientY>=i.top&&e.clientY<=i.bottom&&e.clientX>=i.left&&e.clientX<=i.right)},isAcceptedDrag(){if(-1!==this.acceptedDropArray.indexOf("any"))return!0;let t=-1!==this.acceptedDropArray.indexOf("from-files");return this.acceptedDropArray.length&&n&&(t=this.acceptedDropArray.reduce((t,e)=>t=t||n.matches(e),!1)),t},sortElement(t,e){let i=this.sortableElements.filter(t=>this.isOverChild(t,e));i.length&&(i=i[0]);const a=(t,e)=>{if(!t)return null;const i=t.previousSibling;return i==e?i:a(i,e)},r=(t,e)=>{if(!t)return null;const i=t.nextSibling;return i==e?i:r(i,e)};let n=a(t,i);if(n)this.sortableContainer.insertBefore(t,n),this.$emit("sort",s);else{let e=r(t,i);e&&(this.sortableContainer.insertBefore(t,e.nextSibling),this.$emit("sort",s))}},disableDrop(){this._dropEnabled=!1},enableDrop(){this._dropEnabled=!0},enableSort(){this._sortEnabled=!0}}}},81:function(t,e,i){"use strict";i.r(e);var a=i(27),s=i(3),r=i(28),n=i(23);e.default={mixins:[a.c,r.a],inject:["getCSFRToken"],components:{FilterBoxView:()=>i.e("filter-box-view").then(i.bind(null,41))},props:{relationName:{type:String,default:""},alreadyInView:{type:Array,default:()=>[]},relationTypes:{type:Object},configPaginateSizes:{type:String,default:"[]"}},data:()=>({method:"relationshipsJson",endpoint:"",loading:!1,selectedObjects:[],addedObjects:[],activeFilter:{},saving:!1,showCreateObjectForm:!1,file:null,objectType:"",titlePlaceholder:"title"}),computed:{knownTypes:()=>["audio","video","image"],isMedia(){return this.relationTypes&&-1!==this.relationTypes.right.indexOf("media")}},mounted(){s.a.listen("relations-view:add-already-in-view",null,this.addToAlreadyInView),s.a.listen("relations-view:remove-already-in-view",null,this.removeFromAlreadyInView)},destroyed(){s.a.stop("relations-view:update-already-in-view",null,this.addToAlreadyInView),s.a.stop("relations-view:remove-already-in-view",null,this.removeFromAlreadyInView)},watch:{relationName:{immediate:!0,handler(t,e){t&&(this.selectedObjects=[],this.endpoint=`${this.method}/${t}`,this.loadObjects()),""===t&&Object(n.a)(500).then(()=>this.objects=[])}},loading(t){this.$emit("loading",t)}},methods:{onFilterObjects(t){this.activeFilter=t,this.toPage(1,this.activeFilter)},onUpdatePageSize(t){this.setPageSize(t),this.loadObjects(this.activeFilter)},onUpdateCurrentPage(t){this.toPage(t,this.activeFilter)},addRelationsToObject(){s.a.sendBack("relations-add:save",this.selectedObjects)},closePanel(){s.a.closePanel()},async createObject({target:t}){if(!t)return;this.saving=!0,this.loading=!0;const e=new FormData(t);""===e.get("title")&&e.set("title",this.titlePlaceholder),e.append("model-type",this.objectType);const i=`${window.location.origin}/${this.objectType}/saveJson`,a={method:"POST",credentials:"same-origin",headers:{accept:"application/json","X-CSRF-Token":this.getCSFRToken()},body:e};try{const e=await fetch(i,a),s=await e.json();let r=(Array.isArray(s.data)?s.data:[s.data])||[];this.objects=r.concat(this.objects),this.selectedObjects=r.concat(this.selectedObjects),this.resetForm(t)}catch(e){if(20===e.code)throw e;alert("Error while uploading/creating new object. Retry"),console.error(e),this.resetForm(t,!0)}finally{this.saving=!1,this.loading=!1}},isUnselectableObject(t){const e=this.addedObjects.map(t=>t.id);return-1!==this.alreadyInView.concat(e).indexOf(t)},addToAlreadyInView(t){this.addedObjects.push(t)},removeFromAlreadyInView(t){this.addedObjects=this.addedObjects.filter(e=>e.id!==t.id)},elementClasses(t){return[`from-relation-${this.relationName}`,{selected:-1!=this.selectedObjects.indexOf(t),unselectable:this.isUnselectableObject(t.id)}]},resetForm(t,e=!1){t.reset(),this.titlePlaceholder="title",this.showCreateObjectForm=e},processFile({target:t}){return this.file=t.files[0],!!this.file&&(this.objectType=this.getObjectType(this.file),this.titlePlaceholder=this.file&&this.file.name,!0)},getObjectType(t){let e=t.type&&t.type.split("/")[0];const i=/audio/g.test(e)?"":"s";return-1===this.knownTypes.indexOf(e)&&(e="file"),`${e}${i}`},paginationPageLinkVisible(t){return this.pagination.page_count<=7||(1===t||t===this.pagination.page_count||t>=this.pagination.page-1&&t<=this.pagination.page+1)},toggle(t,e){let i=this.selectedObjects.indexOf(t);-1!=i?this.selectedObjects.splice(i,1):this.selectedObjects.push(t)},async loadObjects(t){this.objects=[],this.loading=!0;let e=await this.getPaginatedObjects(!0,t);return this.loading=!1,this.$emit("count",this.pagination.count),e},async toPage(t,e){this.objects=[],this.loading=!0;let i=await a.c.methods.toPage.call(this,t,e);return this.loading=!1,i},buildViewUrl:(t,e)=>`${window.location.protocol}/${window.location.host}/${t}/view/${e}`}}}}]);