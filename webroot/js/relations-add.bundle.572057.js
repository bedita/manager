(window.webpackJsonp=window.webpackJsonp||[]).push([["relations-add"],{27:function(e,t,i){"use strict";i.d(t,"b",function(){return a}),i.d(t,"a",function(){return s}),i.d(t,"c",function(){return r});const a={count:0,page:1,page_size:20,page_count:1},s={q:"",filter:{type:[]}},r={data:()=>({requestsQueue:[],requestController:new AbortController,objects:[],endpoint:null,pagination:a,query:{},formatObjetsFilter:["params","priority","position","url"]}),methods:{getPaginatedObjects(e=!0,t={}){let i=window.location.href;if(this.endpoint){t&&(this.query=t);let a=`${i}/${this.endpoint}`;const s={credentials:"same-origin",headers:{accept:"application/json"}};a=this.getUrlWithPaginationAndQuery(a),this.requestsQueue.length>0&&(this.requestController.abort(),this.requestController=new AbortController),s.signal=this.requestController.signal;let r=fetch(a,s).then(e=>e.json()).then(t=>{this.requestsQueue.pop();let i=(Array.isArray(t.data)?t.data:[t.data])||[];return t.data||(i=[]),this.requestsQueue.length<1&&(e&&(this.objects=i),this.pagination=t.meta&&t.meta.pagination||this.pagination,i)}).catch(e=>{if(this.requestsQueue.pop(),20===e.code)throw e;console.error(e)});return this.requestsQueue.push(r),r}return Promise.reject()},formatObjects(e){if(void 0===e)return[];const t=[];return e.forEach(e=>{let i={};i.id=e.id,i.type=e.type;const a=e.meta.relation;if(a){let e={};this.formatObjetsFilter.forEach(t=>{a[t]&&(e[t]=a[t])}),Object.keys(e).length&&(i.meta={relation:e})}t.push(i)}),t},setPagination(e){let t="",i="?";return Object.keys(this.pagination).forEach((e,i)=>{t+=`${i?"&":""}${e}=${this.pagination[e]}`}),-1===e.indexOf(i)||(i="&"),`${e}${i}${t}`},getUrlWithPaginationAndQuery(e){let t="",i="?";return Object.keys(this.pagination).forEach((e,i)=>{t+=`${i?"&":""}${e}=${this.pagination[e]}`}),t.length>1&&(t+="&"),Object.keys(this.query).forEach((e,i)=>{const a=this.query[e];let s=`${e}=${a}`;if("filter"===e){let e="";Object.keys(a).forEach(t=>{""!==a[t]&&(e+=`filter[${t}]=${a[t]}`)}),s=e}t+=`${i?"&":""}${s}`}),-1===e.indexOf(i)||(i="&"),`${e}${i}${t}`},findObjectById(e){let t=this.objects.filter(t=>t.id===e);return t.length&&t[0]},async loadMore(e=a.page_size){if(this.pagination.page_items<this.pagination.count){let t=await this.nextPage(!1);this.pagination.page_items=this.pagination.page_items+e<=this.pagination.count?this.pagination.page_items+e:this.pagination.count;const i=this.objects.length;this.objects.splice(i,0,...t)}},toPage(e,t={}){return this.pagination.page=e||1,this.getPaginatedObjects(!0,t)},firstPage(e=!0){return 1!==this.pagination.page?(this.pagination.page=1,this.getPaginatedObjects(e)):Promise.resolve([])},lastPage(e=!0){return this.pagination.page!==this.pagination.page_count?(this.pagination.page=this.pagination.page_count,this.getPaginatedObjects(e)):Promise.resolve([])},nextPage(e=!0){return this.pagination.page<this.pagination.page_count?(this.pagination.page=this.pagination.page+1,this.getPaginatedObjects(e)):Promise.resolve([])},prevPage(){return this.pagination.page>1?(this.pagination.page=this.pagination.page-1,this.getPaginatedObjects()):Promise.resolve()},setPageSize(e){this.pagination.page_size=e,this.pagination.page=1}}}},28:function(e,t,i){"use strict";const a={data:()=>({_mutationObserver:null,attrs:[]}),mounted(){this.setMutationObserver(this.attrs)},destroyed(){this._mutationObserver.disconnect()},methods:{setMutationObserver(e){this._mutationObserver=new MutationObserver(this.onAttributeChanges),this._mutationObserver.observe(this.$el,{attributes:!0,attributeFilter:e,subtree:!0,attributeOldValue:!0})},setObservableAttrs(e){this.attrs=e,this._mutationObserver.disconnect(),this.setMutationObserver(this.attrs)},onAttributeChanges(e,t){}}};i.d(t,"a",function(){return o});let s={},r={},n=null;const o={mixins:[a],props:{acceptedDrop:{type:Array,default:()=>[]}},data:()=>({attrs:["droppable","accepted-drop"],from:{},overElement:null,dropElement:null,acceptedDropArray:[],draggableElements:[],dragOverFirst:!0,antiGlitchTimer:null,_dropEnabled:!1}),mounted(){this.initDroppableElements(),this.initDraggableElements()},updated(){this.initDroppableElements(),this.initDraggableElements()},destroyed(){this.dropElement.removeEventListener("dragover",this.onDragover,!1),this.dropElement.removeEventListener("dragleave",this.onDragleave,!1),this.dropElement.removeEventListener("drop",this.onDrop,!1),this.draggableElements.length&&this.$el.removeEventListener("dragstart",this.onDragstart,!1)},methods:{onAttributeChanges(e,t){for(var i of e)if("attributes"==i.type)if("droppable"===i.attributeName)this.enableDrop(),this.dropElement=i.target;else if("accepted-drop"===i.attributeName){let e=i.target.getAttribute("accepted-drop");e&&(this.acceptedDropArray=e.split(","))}},initDroppableElements(){if(this.dropElement=this.$el,this.dropElement){let e=this.$el.querySelector("[droppable]");if(e){this.enableDrop(),this.dropElement=e;let t=e.getAttribute("accepted-drop");t&&(this.acceptedDropArray=t.split(","))}this.dropElement.addEventListener("drop",this.onDrop,!0),this.dropElement.addEventListener("dragover",this.onDragover,!0),this.dropElement.addEventListener("dragleave",this.onDragleave,!0)}},initDraggableElements(){let e=this.$el.querySelectorAll("[draggable]");e.length&&(this.draggableElements=e,this.$el.addEventListener("dragstart",this.onDragstart,!0),this.$el.addEventListener("dragend",this.onDragend,!0))},setDragdropData(){s={dragged:n,over:this.overElement,drop:this.dropElement,data:r}},onDragstart(e){let t=(n=e.target).getAttribute("drag-data");try{r=JSON.parse(t)}catch(e){console.error("failed parsing drag data")}this.setDragdropData(),this.$emit("dragstart",e,r)},onDragover(e){if(e.preventDefault(),e.stopPropagation(),!this._dropEnabled)return;s.dragged;this.isAcceptedDrag()&&(window.clearTimeout(this.antiGlitchTimer),this.overElement=e.target,this.setDragdropData(e),this.dropElement.classList.add("dragover"),this.dragOverFirst&&(this.dragOverFirst=!1,this.$emit("dragover-once",e)),this.$emit("dragover",e))},onDragleave(e){e.preventDefault(),e.stopPropagation(),this.overElement=null,this.setDragdropData(e),this.dragOverFirst=!0,this.antiGlitchTimer=window.setTimeout(()=>{this.dropElement.classList.remove("dragover"),this.isOverChild(e)||this.$emit("dragleave")},25)},onDragend(e){s={},r={},n=null},onDrop(e){if(e.preventDefault(),e.stopPropagation(),!this._dropEnabled||!this.isAcceptedDrag())return;this.setDragdropData(e),this.dropElement.classList.remove("dragover"),this.$emit("dragleave");let t=e.target.files||e.dataTransfer.files;t.length?(s.files=t,this.$emit("drop-files",e,s)):this.$emit("drop",e,s),n=null},isOverChild(e){if(!this.dropElement)return!1;let t=this.dropElement.getBoundingClientRect();const i=document.body.clientWidth,a=document.body.clientHeight;return!(e.clientX<=0||e.clientY<=0||e.clientX>i||e.clientY>a)&&(e.clientY>=t.top&&e.clientY<=t.bottom&&e.clientX>=t.left&&e.clientX<=t.right)},isAcceptedDrag(){if(-1!==this.acceptedDropArray.indexOf("any"))return!0;let e=-1!==this.acceptedDropArray.indexOf("from-files");return this.acceptedDropArray.length&&n&&(e=this.acceptedDropArray.reduce((e,t)=>e=e||n.matches(t),!1)),e},disableDrop(){this._dropEnabled=!1},enableDrop(){this._dropEnabled=!0}}}},81:function(e,t,i){"use strict";i.r(t);var a=i(27),s=i(3),r=i(28),n=i(23);t.default={mixins:[a.c,r.a],inject:["getCSFRToken"],components:{FilterBoxView:()=>i.e("filter-box-view").then(i.bind(null,41))},props:{relationName:{type:String,default:""},alreadyInView:{type:Array,default:()=>[]},relationTypes:{type:Object},configPaginateSizes:{type:String,default:"[]"}},data:()=>({method:"relationshipsJson",endpoint:"",loading:!1,selectedObjects:[],addedObjects:[],activeFilter:{},saving:!1,showCreateObjectForm:!1,file:null,objectType:"",titlePlaceholder:"title"}),computed:{knownTypes:()=>["audio","video","image"],isMedia(){return this.relationTypes&&-1!==this.relationTypes.right.indexOf("media")}},mounted(){s.a.listen("relations-view:add-already-in-view",null,this.addToAlreadyInView),s.a.listen("relations-view:remove-already-in-view",null,this.removeFromAlreadyInView)},destroyed(){s.a.stop("relations-view:update-already-in-view",null,this.addToAlreadyInView),s.a.stop("relations-view:remove-already-in-view",null,this.removeFromAlreadyInView)},watch:{relationName:{immediate:!0,handler(e,t){e&&(this.selectedObjects=[],this.endpoint=`${this.method}/${e}`,this.loadObjects()),""===e&&Object(n.a)(500).then(()=>this.objects=[])}},loading(e){this.$emit("loading",e)}},methods:{onFilterObjects(e){this.activeFilter=e,this.toPage(1,this.activeFilter)},onUpdatePageSize(e){this.setPageSize(e),this.loadObjects(this.activeFilter)},onUpdateCurrentPage(e){this.toPage(e,this.activeFilter)},addRelationsToObject(){s.a.sendBack("relations-add:save",this.selectedObjects)},closePanel(){s.a.closePanel()},async createObject({target:e}){if(!e)return;this.saving=!0,this.loading=!0;const t=new FormData(e);""===t.get("title")&&t.set("title",this.titlePlaceholder),t.append("model-type",this.objectType);const i=`${window.location.origin}/${this.objectType}/saveJson`,a={method:"POST",credentials:"same-origin",headers:{accept:"application/json","X-CSRF-Token":this.getCSFRToken()},body:t};try{const t=await fetch(i,a),s=await t.json();let r=(Array.isArray(s.data)?s.data:[s.data])||[];this.objects=r.concat(this.objects),this.selectedObjects=r.concat(this.selectedObjects),this.resetForm(e)}catch(t){if(20===t.code)throw t;alert("Error while uploading/creating new object. Retry"),console.error(t),this.resetForm(e,!0)}finally{this.saving=!1,this.loading=!1}},isUnselectableObject(e){const t=this.addedObjects.map(e=>e.id);return-1!==this.alreadyInView.concat(t).indexOf(e)},addToAlreadyInView(e){this.addedObjects.push(e)},removeFromAlreadyInView(e){this.addedObjects=this.addedObjects.filter(t=>t.id!==e.id)},elementClasses(e){return[`from-relation-${this.relationName}`,{selected:-1!=this.selectedObjects.indexOf(e),unselectable:this.isUnselectableObject(e.id)}]},resetForm(e,t=!1){e.reset(),this.titlePlaceholder="title",this.showCreateObjectForm=t},processFile({target:e}){return this.file=e.files[0],!!this.file&&(this.objectType=this.getObjectType(this.file),this.titlePlaceholder=this.file&&this.file.name,!0)},getObjectType(e){let t=e.type&&e.type.split("/")[0];const i=/audio/g.test(t)?"":"s";return-1===this.knownTypes.indexOf(t)&&(t="file"),`${t}${i}`},paginationPageLinkVisible(e){return this.pagination.page_count<=7||(1===e||e===this.pagination.page_count||e>=this.pagination.page-1&&e<=this.pagination.page+1)},toggle(e,t){let i=this.selectedObjects.indexOf(e);-1!=i?this.selectedObjects.splice(i,1):this.selectedObjects.push(e)},async loadObjects(e){this.objects=[],this.loading=!0;let t=await this.getPaginatedObjects(!0,e);return this.loading=!1,this.$emit("count",this.pagination.count),t},async toPage(e,t){this.objects=[],this.loading=!0;let i=await a.c.methods.toPage.call(this,e,t);return this.loading=!1,i},buildViewUrl:(e,t)=>`${window.location.protocol}/${window.location.host}/${e}/view/${t}`}}}}]);